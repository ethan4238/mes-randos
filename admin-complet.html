<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration Compl√®te</title>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700;800&display=swap');
        
        body { margin: 0; padding: 0; background: #f1f5f9; font-family: 'Nunito Sans', sans-serif; color: #0f172a; }
        
        /* Navigation */
        .navbar { background: white; padding: 15px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 100; }
        .nav-btn { background: none; border: none; padding: 10px 20px; font-weight: 700; color: #64748b; cursor: pointer; border-radius: 50px; transition: 0.3s; font-size: 1rem; }
        .nav-btn:hover { background: #f8fafc; color: #0f172a; }
        .nav-btn.active { background: #0f172a; color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }

        /* Conteneur */
        .container { max-width: 800px; margin: 30px auto; padding: 0 20px; }
        .tab-content { display: none; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 25px; }
        h3 { color: #334155; border-left: 4px solid #f97316; padding-left: 10px; margin-top: 40px; margin-bottom: 20px; }
        
        /* Formulaires */
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #334155; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; margin-bottom: 20px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 100px; resize: vertical; }

        /* Checkboxes Tags */
        .tags-wrapper { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tags-wrapper label { display: flex; align-items: center; gap: 5px; font-weight: 600; cursor: pointer; background: #f8fafc; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; transition: 0.2s; }
        .tags-wrapper label:hover { background: #e2e8f0; }
        .tags-wrapper input[type="checkbox"] { width: auto; margin: 0; }

        /* Boutons */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 1.1rem; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; color: white; margin-bottom: 10px; }
        .btn-green { background: #10b981; } .btn-green:hover { background: #059669; }
        .btn-blue { background: #3b82f6; } .btn-blue:hover { background: #2563eb; }
        .btn-orange { background: #f97316; } .btn-orange:hover { background: #ea580c; }
        .btn-red { background: #ef4444; } .btn-red:hover { background: #dc2626; }
        .btn-purple { background: #8b5cf6; } .btn-purple:hover { background: #7c3aed; }

        /* Galerie Photos */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 10px; margin-bottom: 20px; }
        .photo-card { position: relative; height: 100px; border-radius: 10px; overflow: hidden; border: 2px solid #e2e8f0; }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; }
        .delete-photo-btn { position: absolute; top: 5px; right: 5px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: 0.2s; }
        .delete-photo-btn:hover { transform: scale(1.2); background: red; }

        /* Messages */
        .msg { padding: 15px; border-radius: 10px; margin-top: 20px; display: none; font-weight: bold; text-align: center; }
        .msg-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .msg-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>

    <div class="navbar">
        <button class="nav-btn active" onclick="switchTab('tab-add')"><i class="fa-solid fa-plus"></i> Cr√©er</button>
        <button class="nav-btn" onclick="switchTab('tab-edit')"><i class="fa-solid fa-pen-to-square"></i> Modifier</button>
        <button class="nav-btn" onclick="switchTab('tab-delete')"><i class="fa-solid fa-trash"></i> Supprimer</button>
    </div>

    <div class="container">
        
        <div id="tab-add" class="tab-content active">
            <h2><i class="fa-solid fa-mountain-sun"></i> Cr√©er une nouvelle fiche</h2>
            
            <label>Titre</label> <input type="text" id="add-title" placeholder="Ex: Mont Blanc">
            <label>Difficult√©</label>
            <select id="add-difficulty">
                <option value="Facile">Facile</option>
                <option value="Moyenne" selected>Moyenne</option>
                <option value="Difficile">Difficile</option>
                <option value="Expert">Expert</option>
            </select>

            <label>Tags</label>
            <div class="tags-wrapper">
                <label><input type="checkbox" name="add-tags" value="Bivouac"> Bivouac ‚õ∫</label>
                <label><input type="checkbox" name="add-tags" value="Coucher de soleil"> Coucher de soleil üåÖ</label>
                <label><input type="checkbox" name="add-tags" value="Mer de nuage"> Mer de nuage ‚òÅÔ∏è</label>
                <label><input type="checkbox" name="add-tags" value="Alpinisme"> Alpinisme üßó</label>
                <label><input type="checkbox" name="add-tags" value="Neige"> Neige ‚ùÑÔ∏è</label>
                <label><input type="checkbox" name="add-tags" value="Lac"> Lac üíß</label>
                <label><input type="checkbox" name="add-tags" value="Faune"> Faune üêê</label>
            </div>

            <label>Description</label> <textarea id="add-desc" placeholder="Description..."></textarea>

            <label>Fichiers</label>
            <button class="btn btn-green" onclick="openWidget('gpx', 'add')">üìÇ Uploader GPX</button>
            <div id="add-gpx-status" style="font-size:0.9rem; color:#10b981; margin-bottom:10px;"></div>
            <input type="hidden" id="add-gpx-url">

            <button class="btn btn-blue" onclick="openWidget('image', 'add')">üì∏ Ajouter Photos</button>
            <div id="add-preview" class="photo-grid"></div>

            <hr style="margin:30px 0; border:0; border-top:1px solid #e2e8f0;">
            <button class="btn btn-orange" onclick="creerRando()">ENREGISTRER LA RANDO</button>
        </div>


        <div id="tab-edit" class="tab-content">
            <h2><i class="fa-solid fa-pen-to-square"></i> Modifier une fiche</h2>
            
            <select id="select-edit-data" onchange="chargerInfosModif()">
                <option value="">-- Choisir une randonn√©e √† modifier --</option>
            </select>

            <div id="edit-form-area" style="display:none;">
                <h3>üìù Informations G√©n√©rales</h3>
                <label>Titre</label> <input type="text" id="edit-title">
                <label>Difficult√©</label>
                <select id="edit-difficulty">
                    <option value="Facile">Facile</option>
                    <option value="Moyenne">Moyenne</option>
                    <option value="Difficile">Difficile</option>
                    <option value="Expert">Expert</option>
                </select>

                <label>Tags</label>
                <div class="tags-wrapper">
                    <label><input type="checkbox" name="edit-tags" value="Bivouac"> Bivouac ‚õ∫</label>
                    <label><input type="checkbox" name="edit-tags" value="Coucher de soleil"> Coucher de soleil üåÖ</label>
                    <label><input type="checkbox" name="edit-tags" value="Mer de nuage"> Mer de nuage ‚òÅÔ∏è</label>
                    <label><input type="checkbox" name="edit-tags" value="Alpinisme"> Alpinisme üßó</label>
                    <label><input type="checkbox" name="edit-tags" value="Neige"> Neige ‚ùÑÔ∏è</label>
                    <label><input type="checkbox" name="edit-tags" value="Lac"> Lac üíß</label>
                    <label><input type="checkbox" name="edit-tags" value="Faune"> Faune üêê</label>
                </div>

                <label>Description</label> <textarea id="edit-desc"></textarea>

                <button class="btn btn-purple" onclick="sauvegarderInfosTexte()">üíæ SAUVEGARDER LES INFOS TEXTE</button>

                <h3>üó∫Ô∏è Trace GPX</h3>
                <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.9rem;">
                    Lien actuel : <span id="current-gpx-display" style="color:#64748b;">Aucun</span>
                </div>
                <button class="btn btn-green" onclick="openWidget('gpx', 'update_gpx')">üîÑ Remplacer le GPX</button>
                <div id="edit-gpx-status" style="color:#10b981; font-weight:bold;"></div>
                <input type="hidden" id="edit-gpx-url">
                <button class="btn btn-purple" onclick="sauvegarderInfosTexte()" style="margin-top:10px;">üíæ SAUVEGARDER LE NOUVEAU GPX</button>


                <h3>üì∏ Gestion des Photos</h3>
                <p style="color:#64748b; font-size:0.9rem;">Ajoute ou supprime des photos (Sauvegarde imm√©diate).</p>
                
                <div id="gallery-edit" class="photo-grid">Chargement...</div>
                
                <button class="btn btn-blue" onclick="openWidget('image', 'add_photo_direct')">‚ûï Ajouter une photo</button>
            </div>
        </div>


        <div id="tab-delete" class="tab-content">
            <h2 style="color:#ef4444;"><i class="fa-solid fa-triangle-exclamation"></i> Supprimer une Rando</h2>
            <p style="background:#fff1f2; color:#be123c; padding:15px; border-radius:10px;">Attention, c'est irr√©versible.</p>
            <select id="select-delete">
                <option value="">-- Choisir la rando √† supprimer --</option>
            </select>
            <button class="btn btn-red" onclick="supprimerRandoDefinitivement()">üóëÔ∏è TOUT SUPPRIMER</button>
        </div>

        <div id="global-msg" class="msg"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDQ-SNampe1cwRgAXrGcd1Ta_aVJKOqGE",
            authDomain: "ethan-randos.firebaseapp.com",
            projectId: "ethan-randos",
            storageBucket: "ethan-randos.firebasestorage.app",
            messagingSenderId: "478245028007",
            appId: "1:478245028007:web:401c3f0cd25dc0a1745b82",
            measurementId: "G-2ZZ60TDVDP"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const cloudName = "dkbulsjyo"; 
        const uploadPreset = "ethan_upload"; 

        let newPhotosForAdd = []; 

        // --- 2. GESTION ONGLETS ---
        window.switchTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Mise √† jour boutons nav
            if(tabId === 'tab-add') document.querySelector('button[onclick*="tab-add"]').classList.add('active');
            if(tabId === 'tab-edit') {
                document.querySelector('button[onclick*="tab-edit"]').classList.add('active');
                chargerListesDeroulantes();
            }
            if(tabId === 'tab-delete') {
                document.querySelector('button[onclick*="tab-delete"]').classList.add('active');
                chargerListesDeroulantes();
            }
        }

        async function chargerListesDeroulantes() {
            const selects = [document.getElementById('select-edit-data'), document.getElementById('select-delete')];
            try {
                const querySnapshot = await getDocs(collection(db, "randos"));
                selects.forEach(sel => {
                    if(!sel) return;
                    const currentVal = sel.value;
                    sel.innerHTML = '<option value="">-- Choisir une randonn√©e --</option>';
                    querySnapshot.forEach(doc => {
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.text = doc.data().title;
                        sel.appendChild(opt);
                    });
                    if(currentVal) sel.value = currentVal;
                });
            } catch (e) { console.error(e); }
        }

        function showMsg(text, type='success') {
            const div = document.getElementById('global-msg');
            div.className = `msg ${type === 'success' ? 'msg-success' : 'msg-error'}`;
            div.innerText = text;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 4000);
        }

        // --- 3. CLOUDINARY ---
        window.openWidget = function(type, context) {
            cloudinary.openUploadWidget({ 
                cloudName, uploadPreset, 
                sources: ['local', 'url'],
                multiple: (context === 'add'), 
            }, async (error, result) => {
                if (!error && result && result.event === "success") {
                    const url = result.info.secure_url;
                    
                    if (context === 'add') {
                        if (type === 'image') {
                            newPhotosForAdd.push({ image: url });
                            document.getElementById('add-preview').innerHTML += `<div class="photo-card"><img src="${url}"></div>`;
                        } else {
                            document.getElementById('add-gpx-url').value = url;
                            document.getElementById('add-gpx-status').innerText = "‚úÖ GPX pr√™t";
                        }
                    } 
                    else if (context === 'update_gpx') {
                        document.getElementById('edit-gpx-url').value = url;
                        document.getElementById('edit-gpx-status').innerText = "‚úÖ Nouveau GPX charg√© ! (Clique sur Sauvegarder)";
                    }
                    else if (context === 'add_photo_direct') {
                        await ajouterPhotoExistante(url);
                    }
                }
            });
        }

        // --- 4. CR√âATION ---
        window.creerRando = async function() {
            const title = document.getElementById('add-title').value;
            const diff = document.getElementById('add-difficulty').value;
            const desc = document.getElementById('add-desc').value;
            const gpx = document.getElementById('add-gpx-url').value;

            // R√©cup√©ration des tags coch√©s
            const tags = Array.from(document.querySelectorAll('input[name="add-tags"]:checked')).map(cb => cb.value);

            if(!title || !gpx) { showMsg("Titre et GPX obligatoires !", "error"); return; }

            try {
                await addDoc(collection(db, "randos"), {
                    title, difficulty: diff, description: desc, gpx,
                    tags: tags, // AJOUT DES TAGS ICI
                    photos: newPhotosForAdd,
                    dateAjout: new Date()
                });
                showMsg("‚úÖ Randonn√©e cr√©√©e avec succ√®s !");
                setTimeout(() => location.reload(), 1500);
            } catch(e) { showMsg("Erreur: " + e.message, "error"); }
        }

        // --- 5. MODIFICATION (Tout en un) ---
        window.chargerInfosModif = async function() {
            const id = document.getElementById('select-edit-data').value;
            const form = document.getElementById('edit-form-area');

            if(!id) { form.style.display = 'none'; return; }

            try {
                const docSnap = await getDoc(doc(db, "randos", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Remplissage Texte
                    document.getElementById('edit-title').value = data.title || "";
                    document.getElementById('edit-difficulty').value = data.difficulty || "Moyenne";
                    document.getElementById('edit-desc').value = data.description || "";
                    document.getElementById('edit-gpx-url').value = data.gpx || "";
                    document.getElementById('current-gpx-display').innerText = data.gpx ? "Fichier actuel OK" : "Aucun";
                    
                    // Remplissage des Tags (cocher les cases)
                    const tags = data.tags || [];
                    document.querySelectorAll('input[name="edit-tags"]').forEach(cb => {
                        cb.checked = tags.includes(cb.value);
                    });

                    // Remplissage Galerie Photos
                    chargerGalerieVisuelle(data.photos || [], id);

                    form.style.display = 'block';
                }
            } catch(e) { console.error(e); showMsg("Erreur de chargement", "error"); }
        }

        function chargerGalerieVisuelle(photos, randoId) {
            const gallery = document.getElementById('gallery-edit');
            gallery.innerHTML = '';
            if(photos.length === 0) gallery.innerHTML = '<p style="color:#64748b;">Aucune photo.</p>';

            photos.forEach(photoObj => {
                const url = (typeof photoObj === 'object' && photoObj.image) ? photoObj.image : photoObj;
                const div = document.createElement('div');
                div.className = 'photo-card';
                div.innerHTML = `
                    <img src="${url}">
                    <button class="delete-photo-btn" onclick="supprimerPhotoExistante('${randoId}', '${url}')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>`;
                gallery.appendChild(div);
            });
        }

        // Sauvegarde Texte + GPX + Tags
        window.sauvegarderInfosTexte = async function() {
            const id = document.getElementById('select-edit-data').value;
            if(!id) return;

            // R√©cup√©ration des tags modifi√©s
            const tags = Array.from(document.querySelectorAll('input[name="edit-tags"]:checked')).map(cb => cb.value);

            try {
                await updateDoc(doc(db, "randos", id), {
                    title: document.getElementById('edit-title').value,
                    difficulty: document.getElementById('edit-difficulty').value,
                    description: document.getElementById('edit-desc').value,
                    gpx: document.getElementById('edit-gpx-url').value,
                    tags: tags // MISE A JOUR DES TAGS
                });
                showMsg("‚úÖ Infos mises √† jour !");
            } catch(e) { showMsg("Erreur: " + e.message, "error"); }
        }

        // Ajout Photo (Direct)
        window.ajouterPhotoExistante = async function(url) {
            const id = document.getElementById('select-edit-data').value;
            if(!id) return;
            try {
                await updateDoc(doc(db, "randos", id), {
                    photos: arrayUnion({ image: url })
                });
                showMsg("Photo ajout√©e !");
                chargerInfosModif(); // Rafraichir
            } catch(e) { showMsg("Erreur ajout photo", "error"); }
        }

        // Suppression Photo (Direct)
        window.supprimerPhotoExistante = async function(randoId, url) {
            if(!confirm("Supprimer cette photo ?")) return;
            try {
                await updateDoc(doc(db, "randos", randoId), { photos: arrayRemove({ image: url }) });
                await updateDoc(doc(db, "randos", randoId), { photos: arrayRemove(url) }); 
                
                showMsg("Photo supprim√©e !");
                chargerInfosModif();
            } catch(e) { showMsg("Erreur suppression", "error"); }
        }

        // --- 6. SUPPRESSION TOTALE ---
        window.supprimerRandoDefinitivement = async function() {
            const id = document.getElementById('select-delete').value;
            if(!id) return;
            if(confirm("‚ö†Ô∏è ES-TU S√õR ? C'est irr√©versible.")) {
                try {
                    await deleteDoc(doc(db, "randos", id));
                    showMsg("Randonn√©e supprim√©e.");
                    setTimeout(() => location.reload(), 1500);
                } catch(e) { showMsg("Erreur: " + e.message, "error"); }
            }
        }
    </script>
</body>
</html>