<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ajouter Rando</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <style>
        body { padding: 40px 20px; background: #f1f5f9; font-family: 'Nunito Sans', sans-serif; }
        .admin-container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0f172a; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #334155; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; }

        .btn-upload { width: 100%; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-gpx { background: #10b981; }
        .btn-photo { background: #3b82f6; margin-top: 10px; }
        .btn-submit { background: #f97316; font-size: 1.1rem; padding: 15px; margin-top: 30px; }
        .btn-submit:hover { background: #ea580c; transform: translateY(-2px); }

        .status-msg { margin-top: 10px; font-size: 0.9rem; font-weight: bold; }
        .success-box { background: #dcfce7; color: #166534; padding: 15px; border-radius: 12px; text-align: center; margin-top: 20px; display: none; border: 1px solid #bbf7d0; }
        
        #preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>üî• Ajouter une Rando</h1>

    <div class="form-group">
        <label>Titre de la sortie</label>
        <input type="text" id="title" placeholder="Ex: Lac du Lauvitel">
    </div>

    <div class="form-group">
        <label>Difficult√©</label>
        <select id="difficulty">
            <option value="Facile">Facile (Vert)</option>
            <option value="Moyenne" selected>Moyenne (Orange)</option>
            <option value="Difficile">Difficile (Rouge)</option>
            <option value="Expert">Expert (Noir)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Description</label>
        <textarea id="desc" placeholder="Raconte ton aventure..."></textarea>
    </div>

    <div class="form-group">
        <label>Fichiers</label>
        <button class="btn-upload btn-gpx" onclick="openWidget('gpx')">
            üìÇ Uploader le GPX
        </button>
        <div id="gpx-status" class="status-msg" style="color:#10b981;"></div>
        <input type="hidden" id="gpx-url">

        <button class="btn-upload btn-photo" onclick="openWidget('image')">
            üì∏ Ajouter des Photos
        </button>
        <div id="preview"></div>
    </div>

    <button class="btn-upload btn-submit" onclick="envoyerVersFirebase()">
        ENREGISTRER SUR LE SITE
    </button>

    <div id="success-message" class="success-box">
        ‚úÖ Randonn√©e ajout√©e avec succ√®s !<br>Elle est visible imm√©diatement sur le site.
    </div>
</div>

<script type="module">
    // --- 1. IMPORTATION FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 2. TA CONFIGURATION (Celle que tu m'as donn√©e) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDDQ-SNampe1cwRgAXrGcd1Ta_aVJKOqGE",
        authDomain: "ethan-randos.firebaseapp.com",
        projectId: "ethan-randos",
        storageBucket: "ethan-randos.firebasestorage.app",
        messagingSenderId: "478245028007",
        appId: "1:478245028007:web:401c3f0cd25dc0a1745b82",
        measurementId: "G-2ZZ60TDVDP"
    };

    // Initialisation
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // --- 3. CONFIGURATION CLOUDINARY ---
    const cloudName = "dkbulsjyo"; 
    // üëá REMPLACE CECI PAR TON PRESET "UNSIGNED" QUE TU AS CR√â√â üëá
    const uploadPreset = "ethan_upload"; 
    
    window.uploadedPhotos = [];

    // Fonction pour ouvrir le widget Cloudinary
    window.openWidget = function(type) {
        cloudinary.openUploadWidget({ 
            cloudName: cloudName, 
            uploadPreset: uploadPreset, 
            sources: ['local', 'url'],
            multiple: type === 'image',
            clientAllowedFormats: type === 'image' ? ['png', 'jpg', 'jpeg', 'webp'] : ['gpx', 'xml'],
            maxFileSize: 10000000 // 10MB max
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                console.log('Fichier upload√© :', result.info.secure_url);
                
                if (type === 'image') {
                    // Ajouter √† la liste des photos
                    window.uploadedPhotos.push({ image: result.info.secure_url });
                    // Petit aper√ßu visuel
                    const img = document.createElement('img');
                    img.src = result.info.secure_url;
                    img.className = 'thumb';
                    document.getElementById('preview').appendChild(img);
                } else {
                    // Sauvegarder l'URL du GPX
                    document.getElementById('gpx-url').value = result.info.secure_url;
                    document.getElementById('gpx-status').innerText = "‚úÖ Fichier GPX charg√© !";
                }
            }
        });
    }

    // --- 4. ENVOI VERS FIREBASE ---
    window.envoyerVersFirebase = async function() {
        const title = document.getElementById('title').value;
        const diff = document.getElementById('difficulty').value;
        const desc = document.getElementById('desc').value;
        const gpx = document.getElementById('gpx-url').value;
        const btn = document.querySelector('.btn-submit');

        // V√©rification simple
        if(!title || !gpx) { 
            alert("‚ö†Ô∏è Il manque le Titre ou le fichier GPX !"); 
            return; 
        }

        btn.innerText = "Envoi en cours...";
        btn.disabled = true;

        try {
            // On √©crit dans la base de donn√©es "randos"
            await addDoc(collection(db, "randos"), {
                title: title,
                difficulty: diff,
                description: desc,
                gpx: gpx,
                photos: window.uploadedPhotos,
                dateAjout: new Date() // Date automatique pour trier plus tard
            });
            
            // Succ√®s !
            document.getElementById('success-message').style.display = 'block';
            btn.innerText = "ENREGISTRER SUR LE SITE";
            btn.disabled = false;
            
            // On vide le formulaire au bout de 2 secondes
            setTimeout(() => {
                location.reload();
            }, 2000);

        } catch (e) {
            console.error("Erreur Firebase : ", e);
            alert("‚ùå Erreur lors de l'enregistrement : " + e.message);
            btn.innerText = "R√©essayer";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>